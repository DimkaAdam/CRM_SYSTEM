<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'crm/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Подключаем Chart.js -->
    <style>
        .analytics-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .chart-container, .stats-container {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stats-container {
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="layout">
        <nav class="sidebar">
            <ul>
                <li><a href="{% url 'client_list' %}">Clients</a></li>
                <li><a href="{% url 'deal_list' %}">Deals</a></li>
                <li><a href="{% url 'task_list' %}">Tasks</a></li>
                <li><a href="{% url 'pipeline_list' %}">My Pipelines</a></li>
            </ul>
        </nav>

        <div class="content">
            <h1>Sales Analytics</h1>
            <div class="analytics-container">
                <!-- График -->
                <div class="chart-container">
                    {% if suppliers_income %}
                        <canvas id="salesChart" width="300" height="150"></canvas> <!-- Место для графика -->
                    {% else %}
                        <p>No data available for sales analytics.</p>
                    {% endif %}
                </div>

                <!-- Статистика -->
                <div class="stats-container">
                    <h2>Other Statistics</h2>
                    <ul>
                       <li>Total Deals: <strong>{{ total_deals }}</strong></li>
                        <li>Total Sale: <strong>${{ total_sale }}</strong></li>
                        <li># of Pallets: <strong>{{ total_pallets }}</strong></li>
                        <li>Transportation Fee: <strong>${{ transportation_fee }}</strong></li>
                        <li>Suppliers: <strong>${{ suppliers_total }}</strong></li>
                        <li>MT OCC11: <strong>{{ mt_occ11 }}</strong></li>
                        <li>MT Plastic: <strong>${{ mt_plastic }}</strong></li>
                        <li>MT Mixed-containers: <strong>{{ mt_mixed_containers }}</strong></li>
                        <li>Income: <strong>${{ income }}</strong></li>
                    </ul>
                </div>
            </div>

            <!-- График палет -->
            <div class="block">
                <h2>Pallet Analytics</h2>
                <form method="POST">
                    {% csrf_token %}
                    <table>
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Current Pallets</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pallet in company_pallets %}
                            <tr>
                                <td>{{ pallet.company_name.name }}</td>
                                <td>{{ pallet.pallets_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="submit" name="reset_pallets" class="reset-btn">Reset All Pallets</button>
                </form>
            </div>


            <script>
                // Данные для графика
                const suppliersIncome = {{ suppliers_income|safe }};

                // Проверяем, есть ли данные
                if (!suppliersIncome || Object.keys(suppliersIncome).length === 0) {
                    console.error('No data available for sales analytics');
                    alert('No data available for sales analytics.');
                }

                // Подготовка данных для Chart.js
                const labels = Object.keys(suppliersIncome);
                const data = Object.values(suppliersIncome);

                var ctx = document.getElementById('salesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Income/Loss',
                            data: data,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        </div>
    </div>
</body>
</html>
