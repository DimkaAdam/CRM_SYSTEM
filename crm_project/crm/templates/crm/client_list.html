{% extends 'crm/index.html' %}

{% block title %}Contact List{% endblock %}

{% block content %}
    <div class="content">
        <h1>Contact</h1>

        <!-- Кнопка для добавления клиента -->
        <button id="addContactBtn" class="add-contact-btn">Add Contact</button>
        <!-- Кнопка Cancel рядом с Add Contact -->
        <button id="cancelBtn" class="cancel-btn" style="display: none;">Cancel</button>

        <!-- Боковая панель для формы добавления клиента -->
        <div id="addClientSidebar" class="sidebar-form">
            <div class="sidebar-header">
                <h3>Add Contact</h3>
                <button id="closeSidebarBtn" class="close-btn">&times;</button>
            </div>
            <form id="clientForm">
                <label for="name"></label>
                <input type="text" id="name" placeholder="Name" required><br><br>
                <label for="email"></label>
                <input type="email" id="email" placeholder="Email" required><br><br>
                </label>
                <input type="tel" id="phone" placeholder="Phone"
                       pattern="[\+][0-9]{1,3}[-][0-9]{1,4}[-][0-9]{1,4}[-][0-9]{1,4}"
                       required><br><br>
                <label for="company"></label>
                <input type="text" id="company" placeholder="Company" required><br><br>
                <button type="submit" class="add-btn">Add</button>
            </form>
        </div>

        <!-- Таблица клиентов -->
        <table id="clientTable" class="client-table">
            <thead>
                <tr>
                    <th>Contact</th>
                    <th>Latest Deals</th>
                    <th>Company</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                    <tr>
                        <td>{{ client.name }}<br><span>{{ client.email }}</span><br><span>{{ client.phone }}</span></td>
                        <td>No deals <button class="add-deal-btn">Add deal</button></td>
                        <td>{{ client.company }}</td>
                        <td>{{ client.created }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4">No clients</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Скрипт для обработки открытия/закрытия боковой панели -->
    <script>
        // Обработчик для кнопки Add Contact
        document.getElementById('addContactBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '300px';
            document.getElementById('cancelBtn').style.display = 'inline';
        });

        // Обработчик для кнопки Cancel
        document.getElementById('cancelBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '0';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('clientForm').reset();
        });

        // Открыть боковую панель
        document.getElementById('addContactBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '300px';
            document.getElementById('cancelBtn').style.display = 'inline';
        });

        // Закрыть боковую панель
        document.getElementById('closeSidebarBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '0';
            document.getElementById('cancelBtn').style.display = 'none';
        });

        // Обработать отправку формы
        document.getElementById('clientForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const company = document.getElementById('company').value;

            // Отправка данных на API
            fetch('http://127.0.0.1:8000/api/clients/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    company: company,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        // Добавляем нового клиента в таблицу
                        const clientTable = document.getElementById('clientTable').getElementsByTagName('tbody')[0];
                        const newRow = clientTable.insertRow();
                        newRow.innerHTML = `
                            <td>${data.name}<br><span>${data.email}</span></td>
                            <td>No deals <button class="add-deal-btn">Add deal</button></td>
                            <td>${data.company}</td>
                            <td>${data.created}</td>
                        `;

                        // Закрыть боковую панель
                        document.getElementById('addClientSidebar').style.width = '0';
                        document.getElementById('cancelBtn').style.display = 'none';
                        document.getElementById('clientForm').reset();
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    </script>
{% endblock %}
