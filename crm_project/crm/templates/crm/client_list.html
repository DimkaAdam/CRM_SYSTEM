{% extends 'crm/index.html' %}

{% load static %}

{% block title %}Contact List{% endblock %}

{% block content %}
    <div class="content">
        <h1>Contact</h1>

        <!-- filter button -->
        <div class="dropdown">
            <select id="categorySelect">
                <option value="all">All Clients</option>
                <option value="supplier">Supplier</option>
                <option value="buyer">Buyer</option>
            </select>
        </div>

        <!-- Кнопка для добавления клиента -->
        <button id="addContactBtn" class="add-contact-btn">Add Contact</button>
        <!-- Кнопка Cancel рядом с Add Contact -->
        <button id="cancelBtn" class="cancel-btn" style="display: none;">Cancel</button>

        <!-- Боковая панель для формы добавления клиента -->
        <div id="addClientSidebar" class="sidebar-form">
            <div class="sidebar-header">
                <h3>Add Contact</h3>
                <button id="closeSidebarBtn" class="close-btn">&times;</button>
            </div>
            <form id="clientForm">
                <label for="name"></label>
                <input type="text" id="name" placeholder="Name" required><br><br>
                <label for="email"></label>
                <input type="email" id="email" placeholder="Email" required><br><br>
                <input type="tel" id="phone" placeholder="Phone"
                       pattern="[\+][0-9]{1,3}[-][0-9]{1,4}[-][0-9]{1,4}[-][0-9]{1,4}"
                       required><br><br>
                <label for="company"></label>
                <input type="text" id="company" placeholder="Company" required><br><br>
                <label for="clientType"></label>
                <select id="clientType" required>
                    <option value="supplier">Supplier</option>
                    <option value="buyer">Buyer</option>
                </select><br><br>
                <button type="submit" class="add-btn">Add</button>
            </form>
        </div>

        <!-- Таблица клиентов -->
        <table id="clientTable" class="client-table">
            <thead>
                <tr>
                    <th>Contact</th>
                    <th>Latest Deals</th>
                    <th>Company</th>
                    <th>Created</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                    <tr>
                        <td>{{ client.name }}<br><span>{{ client.email }}</span><br><span>{{ client.phone }}</span></td>
                        <td>No deals <button class="add-deal-btn">Add deal</button></td>
                        <td>{{ client.company }}</td>
                        <td>{{ client.created }}</td>
                        <td>{{ client.type|default:"Not specified" }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">No clients</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Скрипт для обработки открытия/закрытия боковой панели -->
    <script>
        // Открыть боковую панель
        document.getElementById('addContactBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '300px';
            document.getElementById('cancelBtn').style.display = 'inline';
        });

        // Обработчик для кнопки Cancel
        document.getElementById('cancelBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '0';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('clientForm').reset();
        });

        // Закрыть боковую панель
        document.getElementById('closeSidebarBtn').addEventListener('click', function () {
            document.getElementById('addClientSidebar').style.width = '0';
            document.getElementById('cancelBtn').style.display = 'none';
        });

        // Обработать отправку формы
        document.getElementById('clientForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const company = document.getElementById('company').value;
            const clientType = document.getElementById('clientType').value;

            fetch('http://127.0.0.1:8000/api/clients/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    company: company,
                    client_type: clientType, // Отправляем тип клиента
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        const clientTable = document.getElementById('clientTable').getElementsByTagName('tbody')[0];
                        const newRow = clientTable.insertRow();
                        newRow.innerHTML = `
                            <td>${data.name}<br><span>${data.email}</span><br><span>${data.phone || ''}</span></td>
                            <td>No deals <button class="add-deal-btn">Add deal</button></td>
                            <td>${data.company}</td>
                            <td>${data.created}</td>
                            <td>${data.client_type || 'Not specified'}</td>
                        `;

                        document.getElementById('addClientSidebar').style.width = '0';
                        document.getElementById('cancelBtn').style.display = 'none';
                        document.getElementById('clientForm').reset();
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Фильтрация клиентов по типу
        document.getElementById('categorySelect').addEventListener('change', function () {
            const selectedValue = this.value;
            const rows = document.querySelectorAll('#clientTable tbody tr');

            rows.forEach(row => {
                const clientType = row.children[4].textContent.toLowerCase(); // Тип клиента из столбца
                if (selectedValue === 'all' || clientType === selectedValue) {
                    row.style.display = ''; // Показать строку
                } else {
                    row.style.display = 'none'; // Скрыть строку
                }
            });
        });
    </script>
    <!-- Подключаем JavaScript -->
    <script src="{% static 'js/scripts.js' %}"></script>
{% endblock %}
