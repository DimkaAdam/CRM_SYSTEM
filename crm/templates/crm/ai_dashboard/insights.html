{% extends 'crm/index.html' %}
{% block title %}AI Insights{% endblock %}
{% block content %}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ kpi|json_script:"kpi_json" }} {# –ù–∞–¥—ë–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ –≤ JS #}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> {# –ò–∫–æ–Ω–∫–∏ #}

<style>
  .chart-container {
    background: #ffffff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    margin-bottom: 30px;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
  }
  h3.section-title {
    color: #08666e;
    margin-bottom: 15px;
  }
  canvas.fixed-size {
    width: 260px !important;
    height: 260px !important;
    display: block;
    margin: 0 auto;
  }
  .charts-row {
    display: flex;
    gap: 40px;
    justify-content: center;
    align-items: flex-start;
    flex-wrap: wrap;
    padding: 30px;
  }
  .charts-row > div { text-align: center; }


   /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ—Ç–∫–∏ KPI */
  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
    gap:14px;margin:10px auto 24px;
    max-width:none;
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
  .kpi-card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;display:flex;align-items:center;gap:12px;transition:transform .15s ease,box-shadow .15s ease}
  .kpi-card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
  /* –ò–∫–æ–Ω–∫–∞ —Å–ª–µ–≤–∞ */
  .kpi-icon{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#08666e1a;color:#08666e;flex:0 0 42px}
  /* –¢–µ–∫—Å—Ç—ã */
  .kpi-label{font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.04em}
  .kpi-value{font-size:22px;font-weight:800;color:#141b2d;line-height:1.1;margin-top:4px}
  .kpi-sub{font-size:12px;color:#9aa3af;margin-top:2px}
  /* –¶–≤–µ—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —Ç–∏–ø—É */
  .kpi--good .kpi-value{color:#0f9d58}     /* –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ */
  .kpi--bad .kpi-value{color:#d93025}      /* –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ */


  #monthlyTrends {
    height: 400px !important;
    width: 100% !important;
  }

</style>

<div class="kpi-grid">
  <!-- Sales -->
  <div class="kpi-card">
    <div class="kpi-icon"><i class="fas fa-shopping-cart"></i></div>
    <div>
      <div class="kpi-label">Sales</div>
      <div id="kpi-sales" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">Buyer revenue</div>
    </div>
  </div>

   <!-- Net Profit -->
  <div class="kpi-card kpi--good">
    <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
    <div>
      <div class="kpi-label">Net Profit</div>
      <div id="kpi-net_profit" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">This month</div>
    </div>
  </div>

  <!-- Supplier Cost -->
  <div class="kpi-card kpi--bad">
    <div class="kpi-icon"><i class="fas fa-hand-holding-usd"></i></div>
    <div>
      <div class="kpi-label">Supplier Cost</div>
      <div id="kpi-supplier_cost" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">COGS</div>
    </div>
  </div>

  <!-- Transport Cost -->
  <div class="kpi-card kpi--bad">
    <div class="kpi-icon"><i class="fas fa-truck"></i></div>
    <div>
      <div class="kpi-label">Transport Cost</div>
      <div id="kpi-transport_cost" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">$ / total</div>
    </div>
  </div>

  <!-- Margin per ton -->
  <div class="kpi-card">
    <div class="kpi-icon"><i class="fas fa-percentage"></i></div>
    <div>
      <div class="kpi-label">Margin / t</div>
      <div id="kpi-margin_per_t" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">Profit per ton</div>
    </div>
  </div>

  <!-- Tonnage -->
  <div class="kpi-card">
    <div class="kpi-icon"><i class="fas fa-weight-hanging"></i></div>
    <div>
      <div class="kpi-label">Tonnage</div>
      <div id="kpi-tonnage" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">Total shipped</div>
    </div>
  </div>

  <!-- Shipments -->
  <div class="kpi-card">
    <div class="kpi-icon"><i class="fas fa-boxes"></i></div>
    <div>
      <div class="kpi-label">Shipments</div>
      <div id="kpi-shipments" class="kpi-value">‚Äî</div>
      <div class="kpi-sub">Deals count</div>
    </div>
  </div>
</div>



<!-- üìà Supplier Trend Chart -->
<div class="chart-container">
  <h3 class="section-title">üìàSupplier Profit/Loss by Month</h3>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ—Ç—Ä–∏–∫–∏ -->
    <div style="display:flex; gap:6px; background:#f1f1f1; padding:4px; border-radius:8px;">
      <button id="btnMetricProfit" style="padding:6px 10px; border:none; border-radius:6px; background:#08666e; color:#fff;">
        Profit/Loss
      </button>
      <button id="btnMetricTonnage" style="padding:6px 10px; border:none; border-radius:6px; background:#222; color:#fff;">
        Tonnage
      </button>
    </div>

    <!-- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é. –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –±–ª–æ–∫; JS –∑–∞—â–∏—â—ë–Ω. -->
    <div>
      <label for="buyerFilter" style="font-weight: bold;">Buyer:</label>
      <select id="buyerFilter" style="padding:6px; margin-left:8px;">
        <option value="">‚Äî All ‚Äî</option>
      </select>
    </div>

    <div style="display: flex; gap: 10px;">
      <button id="hideAllBtn" style="background: #222; color: #fff; padding: 8px 14px; border: none; border-radius: 6px;">
        Hide All Lines
      </button>
      <button id="showAllBtn" style="background: #08666e; color: #fff; padding: 8px 14px; border: none; border-radius: 6px;">
        Show All Lines
      </button>
    </div>
  </div>

  <canvas id="supplierTrendChart" height="320"></canvas>
</div>

<!-- üü¢ Pie Charts -->
<div class="charts-row">
  <div>
    <h3 style="color: #000;">By Buyers</h3>
    <canvas id="buyerChart" class="fixed-size" width="260" height="260"></canvas>
  </div>
  <div>
    <h3 style="color: #000;">By Suppliers</h3>
    <canvas id="supplierChart" class="fixed-size" width="260" height="260"></canvas>
  </div>
</div>

<!-- üö© Gradient Bars for Problem Suppliers -->
<div class="chart-container" style="background: #1c1f2e;">
  <h3 class="section-title" style="color: #fff;">üö© Problem Suppliers</h3>
  <div style="display: flex; flex-direction: column; gap: 16px;">
    {% for s in problem_suppliers %}
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 100px; color: #ccc; font-size: 14px;">{{ s.name }}</div>
      <div style="flex: 1; background: #3b3f52; border-radius: 20px; overflow: hidden;">
        <div style="
          width: {{ s.percent }}%;
          height: 14px;
          border-radius: 20px;
          background: linear-gradient(to right, #00c3ff, #ffff1c);">
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- üìâ Clients with Drop -->
<div class="chart-container">
  <h3 class="section-title">üìâ Clients with Sharp Drop</h3>
  <canvas id="clientsDropChart"></canvas>
</div>

<!-- üí• Loss-Making Deals -->
<div class="chart-container">
  <h3 class="section-title">üí• Loss-Making Deals</h3>
  <canvas id="lossDealsChart"></canvas>
</div>

<div class="chart-container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <h3 class="section-title" style="margin:0;">üìä Monthly Trends</h3>
    <div class="toggles">
      <button id="tog-net" class="tog-btn is-on">Net Profit</button>
      <button id="tog-sup" class="tog-btn">Supplier Cost</button>
      <button id="tog-tpt" class="tog-btn">Transport $/t</button>
    </div>
  </div>
  <div class="chart-body">
    <canvas id="monthlyTrends"></canvas>
  </div>
</div>


<script>
  // üìâ Clients with Drop
   (function () {
    const canvas = document.getElementById('clientsDropChart');
    const ctx = canvas.getContext('2d');

    // üëá –∏–º–µ–Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ + –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–æ—à–ª—ã–π / —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    const supplierNames = [{% for d in dropped_clients %}'{{ d.supplier.name|escapejs }}',{% endfor %}];
    const lastMonth     = [{% for d in dropped_clients %}{{ d.last_month }},{% endfor %}];
    const thisMonth     = [{% for d in dropped_clients %}{{ d.this_month }},{% endfor %}];

    // üé® –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π ‚Üí —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    const gradBluePurple = ctx.createLinearGradient(0, 0, 0, 300);
    gradBluePurple.addColorStop(0, '#0b1e5b');
    gradBluePurple.addColorStop(1, '#6a00ff');

    // üè∑ –ø–ª–∞–≥–∏–Ω ‚Äî –ø–æ–¥–ø–∏—Å—å –∏–º–µ–Ω–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –Ω–∞–¥ –ø–∞—Ä–æ–π —Å—Ç–æ–ª–±—Ü–æ–≤
    const supplierLabelPlugin = {
      id: 'supplierLabelPlugin',
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        const meta0 = chart.getDatasetMeta(0); // Last Month
        const meta1 = chart.getDatasetMeta(1); // This Month
        if (!meta0?.data?.length) return;

        ctx.save();
        ctx.font = '12px sans-serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';

        meta0.data.forEach((bar, i) => {
          const y0 = bar?.y ?? 0;
          const y1 = meta1?.data?.[i]?.y ?? y0;
          const topY = Math.min(y0, y1) - 6; // —á—É—Ç—å –≤—ã—à–µ –≤–µ—Ä—Ö—É—à–∫–∏
          const x = bar.x;
          const name = supplierNames[i] || '';
          ctx.fillText(name, x, topY);
        });

        ctx.restore();
      }
    };

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: supplierNames, // –æ—Å—Ç–∞—é—Ç—Å—è –∏ –Ω–∞ –æ—Å–∏ X
        datasets: [
          { label: 'Last Month', data: lastMonth, backgroundColor: gradBluePurple },
          { label: 'This Month', data: thisMonth, backgroundColor: '#95a5a6' } // —Å–µ—Ä—ã–π
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              title: (items) => supplierNames[items[0].dataIndex] || '',
              label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}`
            }
          }
        }
      },
      plugins: [supplierLabelPlugin]
    });
  })();

  // üí• Loss-making Deals
  new Chart(document.getElementById('lossDealsChart'), {
    type: 'bar',
    data: {
      labels: [{% for d in worst_deals %}'#{{ d.id }}',{% endfor %}],
      datasets: [{ label: 'Margin (CAD)', data: [{% for d in worst_deals %}{{ d.total_income_loss }},{% endfor %}], backgroundColor: '#f39c12' }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: {
        tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + ctx.raw + ' CAD' } }
      }
    }
  });

  // üü¢ Pie Charts
  fetch("/api/ai/pie-stats/")
    .then(r => r.json())
    .then(data => {
      const sortedSuppliers = Object.entries(data.suppliers).sort((a, b) => b[1] - a[1]).slice(0, 3);
      createPieChart("supplierChart", Object.fromEntries(sortedSuppliers));
      createPieChart("buyerChart", data.buyers);
    });

  function createPieChart(canvasId, dataMap) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");
    const labels = Object.keys(dataMap || {});
    const dataValues = Object.values(dataMap || {});
    const gradientColors = [
      createGradient(ctx, "#2193b0", "#6dd5ed"),
      createGradient(ctx, "#cc2b5e", "#753a88"),
      createGradient(ctx, "#ee9ca7", "#ffdde1"),
      createGradient(ctx, "#42275a", "#734b6d"),
      createGradient(ctx, "#bdc3c7", "#2c3e50"),
      createGradient(ctx, "#614385", "#516395"),
      createGradient(ctx, "#0f2027", "#2c5364"),
      createGradient(ctx, "#ff6a00", "#ee0979")
    ];
    const backgroundColors = dataValues.map((_, i) => gradientColors[i % gradientColors.length]);

    new Chart(canvas, {
      type: 'pie',
      data: { labels, datasets: [{ data: dataValues, backgroundColor: backgroundColors, borderWidth: 0 }] },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#191725', boxWidth: 14, font: { size: 12 } } }
        }
      }
    });
  }
  function createGradient(ctx, colorStart, colorEnd) {
    const g = ctx.createLinearGradient(0, 0, 300, 0);
    g.addColorStop(0, colorStart); g.addColorStop(1, colorEnd);
    return g;
  }

  // üìà Supplier Trend Chart Logic
  let fullSupplierData = {};          // { supplier: { profit:[12], tonnage:[12] }, ... }
  let buyerMap = {};                  // { buyerName: ["Supplier A", ...] }
  let supplierChart = null;           // Chart.js instance
  let currentMetric = 'profit';       // 'profit' | 'tonnage'
  let lastRenderedData = {};          // –ø–æ—Å–ª–µ–¥–Ω—è—è –≤—ã–±–æ—Ä–∫–∞ (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞)

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
  fetch("/api/ai/supplier-monthly/")
    .then(res => res.json())
    .then(data => {
      fullSupplierData = data || {};
      lastRenderedData = fullSupplierData;
      return fetch("/api/ai/buyer-suppliers/");
    })
    .then(res => res.json())
    .then(buyerData => {
      buyerMap = buyerData || {};

      // –ï—Å–ª–∏ —Å–µ–ª–µ–∫—Ç –µ—Å—Ç—å ‚Äî –Ω–∞–ø–æ–ª–Ω—è–µ–º –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º
      const select = document.getElementById("buyerFilter");
      if (select) {
        for (let buyer of Object.keys(buyerMap)) {
          const opt = document.createElement("option");
          opt.value = buyer; opt.textContent = buyer;
          select.appendChild(opt);
        }
        select.addEventListener("change", () => {
          const selected = select.value;
          if (!selected) {
            lastRenderedData = fullSupplierData;
          } else {
            const filtered = {};
            const suppliers = buyerMap[selected] || [];
            for (let sup of suppliers) if (fullSupplierData[sup]) filtered[sup] = fullSupplierData[sup];
            lastRenderedData = filtered;
          }
          renderChart(lastRenderedData, currentMetric);
        });
      }

      // –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
      document.getElementById("hideAllBtn").addEventListener("click", () => {
        if (!supplierChart) return;
        supplierChart.data.datasets.forEach((ds) => {
          const isAllZero = ds.data.every(v => v === 0);
          if (!isAllZero) ds.hidden = true;
        });
        supplierChart.update();
      });
      document.getElementById("showAllBtn").addEventListener("click", () => {
        if (!supplierChart) return;
        supplierChart.data.datasets.forEach((ds) => { ds.hidden = false; });
        supplierChart.update();
      });

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –º–µ—Ç—Ä–∏–∫
      document.getElementById('btnMetricProfit').addEventListener('click', () => {
        currentMetric = 'profit';
        renderChart(lastRenderedData, currentMetric);
        setMetricButtonsActive('profit');
      });
      document.getElementById('btnMetricTonnage').addEventListener('click', () => {
        currentMetric = 'tonnage';
        renderChart(lastRenderedData, currentMetric);
        setMetricButtonsActive('tonnage');
      });

      // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
      renderChart(fullSupplierData, currentMetric);
      setMetricButtonsActive('profit');
    });

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –º–µ—Ç—Ä–∏–∫–∏
  function setMetricButtonsActive(metric) {
    const profitBtn = document.getElementById('btnMetricProfit');
    const tonnageBtn = document.getElementById('btnMetricTonnage');
    if (!profitBtn || !tonnageBtn) return;
    if (metric === 'profit') {
      profitBtn.style.background = '#08666e'; profitBtn.style.color = '#fff';
      tonnageBtn.style.background = '#222';   tonnageBtn.style.color = '#fff';
    } else {
      tonnageBtn.style.background = '#08666e'; tonnageBtn.style.color = '#fff';
      profitBtn.style.background = '#222';     profitBtn.style.color = '#fff';
    }
  }

  // –†–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ —Ç–µ–∫—É—â–µ–π –º–µ—Ç—Ä–∏–∫–µ
  function renderChart(data, metric) {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const keys = Object.keys(data || {});
    const safeData = keys.length ? data : {}; // –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ—Ç—ã

    const gradientPalette = [
      ['#00f2fe', '#4facfe'],
      ['#f093fb', '#f5576c'],
      ['#43e97b', '#38f9d7'],
      ['#fa709a', '#fee140'],
      ['#7ee8fa', '#eec0c6'],
      ['#30cfd0', '#330867'],
      ['#667eea', '#764ba2'],
      ['#ff758c', '#ff7eb3']
    ];

    const ctx = document.getElementById("supplierTrendChart").getContext("2d");

    const datasets = Object.keys(safeData).map((supplier, idx) => {
      const grad = ctx.createLinearGradient(0, 0, 800, 0);
      const [start, end] = gradientPalette[idx % gradientPalette.length];
      grad.addColorStop(0, start); grad.addColorStop(1, end);

      const series = (safeData[supplier] && safeData[supplier][metric]) ? safeData[supplier][metric] : Array(12).fill(0);
      return {
        label: supplier,
        data: series,
        borderColor: grad,
        fill: false,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: grad
      };
    });

    if (supplierChart) supplierChart.destroy();

    const axisTitle = (metric === 'profit') ? '–ü—Ä–∏–±—ã–ª—å (CAD)' : '–¢–æ–Ω–Ω–∞–∂ (—Ç)';

    supplierChart = new Chart(ctx, {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { color: '#000' } } },
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: axisTitle }, ticks: { color: '#444' }, grid: { color: '#eee' } },
          x: { ticks: { color: '#444' }, grid: { color: '#eee' } }
        }
      }
    });
  }



  // # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ KPI –∏–∑ —Ç–µ–≥–∞ <script id="kpi_json">
  const kpi = JSON.parse(document.getElementById("kpi_json").textContent); // # –ü–∞—Ä—Å–∏–º JSON —Å –±—ç–∫–µ–Ω–¥–∞

  // # –§–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞ –∫–∞–∫ –≤–∞–ª—é—Ç—ã CAD
  const money = (v)=>Number(v||0).toLocaleString(undefined,{style:"currency",currency:"CAD",maximumFractionDigits:2}); // # $ —Ñ–æ—Ä–º–∞—Ç
  // # –§–æ—Ä–º–∞—Ç –æ–±—ã—á–Ω–æ–≥–æ —á–∏—Å–ª–∞
  const num   = (v)=>Number(v||0).toLocaleString(undefined,{maximumFractionDigits:2}); // # 1 234.56

  // # –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–∞ (0 ‚Üí target)
  function countUp(el, target, fmt=(x)=>x, duration=700){ // # el=—ç–ª–µ–º–µ–Ω—Ç; target=–∫–æ–Ω–µ—á–Ω–æ–µ —á–∏—Å–ª–æ; fmt=—Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä; duration=–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    const start = performance.now();                      // # –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –≤—Ä–µ–º—è
    const from = 0;                                       // # –ù–∞—á–∏–Ω–∞–µ–º —Å 0 (–º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–µ–µ)
    const t = Number(target||0);                          // # –¶–µ–ª–µ–≤–æ–µ —á–∏—Å–ª–æ
    function frame(now){                                  // # –ö–∞–¥—Ä –∞–Ω–∏–º–∞—Ü–∏–∏
      const p = Math.min((now-start)/duration,1);         // # –ü—Ä–æ–≥—Ä–µ—Å—Å 0..1
      const ease = 1 - Math.pow(1-p,3);                   // # –ü–ª–∞–≤–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ/–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ (easeOutCubic)
      const val = from + (t-from)*ease;                   // # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      el.textContent = fmt(val);                          // # –í—ã–≤–æ–¥–∏–º –≤ —ç–ª–µ–º–µ–Ω—Ç
      if(p<1) requestAnimationFrame(frame);               // # –ï—Å–ª–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ ‚Äî —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
    }
    requestAnimationFrame(frame);                         // # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
  }

  // # –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Å—Ç–∞–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏—è (–µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –µ—Å—Ç—å)
  function setKPI(id, value, formatter){                  // # id = HTML id, value = —á–∏—Å–ª–æ, formatter = —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const el = document.getElementById(id);               // # –ë–µ—Ä—ë–º —ç–ª–µ–º–µ–Ω—Ç
    if(!el) return;                                       // # –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
    countUp(el, value, formatter);                        // # –ê–Ω–∏–º–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
  }

  // # –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
  setKPI("kpi-net_profit",     kpi.net_profit,     money); // # Net Profit
  setKPI("kpi-sales",          kpi.sales,          money); // # Sales
  setKPI("kpi-supplier_cost",  kpi.supplier_cost,  money); // # Supplier Cost
  setKPI("kpi-transport_cost", kpi.transport_cost, money); // # Transport Cost
  setKPI("kpi-margin_per_t",   kpi.margin_per_t,   money); // # Margin per ton (—Ç–æ–∂–µ —É–¥–æ–±–Ω–æ –∫–∞–∫ $/t)
  setKPI("kpi-tonnage",        kpi.tonnage,        num);   // # –û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂
  setKPI("kpi-shipments",      kpi.shipments,      num);   // # –ö–æ–ª-–≤–æ —Å–¥–µ–ª–æ–∫/–æ—Ç–≥—Ä—É–∑–æ–∫



  document.addEventListener('DOMContentLoaded', async () => {
    const res  = await fetch("{% url 'ai_monthly_trends' %}");
    const data = await res.json();
    const ctx  = document.getElementById('monthlyTrends').getContext('2d');

    // helpers
    const money = (v, c='CAD') =>
      Number(v||0).toLocaleString(undefined,{style:'currency',currency:c,maximumFractionDigits:2});
    const finiteArr = (a)=> (a||[]).map(Number).filter(Number.isFinite);

    function bounds(arr, padPct=0.10){
      if (!arr.length) return { min: 0, max: 1 };
      const min = Math.min(...arr), max = Math.max(...arr);
      const span = Math.max(max - min, Math.abs(max) || 1);
      const pad  = Math.max(span * padPct, 1);
      return { min: min - pad, max: max + pad };
    }

    // —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è –≥—Ä–∞–Ω–∏—Ü
    const leftVals  = finiteArr(data.net_profit).concat(finiteArr(data.supplier_cost));
    const rightVals = finiteArr(data.transport_per_t);

    const grad = ctx.createLinearGradient(0,0,0,320);
    grad.addColorStop(0, 'rgba(8,102,110,0.30)');
    grad.addColorStop(1, 'rgba(8,102,110,0.00)');

    const dsNet = {
      label:'Net Profit', data:data.net_profit, yAxisID:'yL',
      borderColor:'#08666e', backgroundColor:grad, fill:false,
      tension:0.35, pointRadius:0, borderWidth:3, spanGaps:true
    };
    const dsSup = {
      label:'Supplier Cost', data:data.supplier_cost, yAxisID:'yL',
      borderColor:'#6b7bd8', backgroundColor:'transparent', fill:false,
      tension:0.35, pointRadius:0, borderWidth:2, spanGaps:true
    };
    const dsTpt = {
      label:'Transport $/t', data:data.transport_per_t, yAxisID:'yR',
      borderColor:'#ff8a00', backgroundColor:'transparent', fill:false,
      tension:0.35, pointRadius:0, borderWidth:2, spanGaps:true
    };

    // –Ω–∞—á–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
    const { min: initMinL, max: initMaxL } = bounds(leftVals);
    const { min: initMinR, max: initMaxR } = bounds(rightVals);

    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: data.months, datasets: [dsNet, dsSup, dsTpt] },
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        layout:{ padding:{ top:8, right:12, bottom:4, left:8 } },
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              label:(cx)=> cx.dataset.yAxisID==='yR'
                ? `${cx.dataset.label}: ${money(cx.parsed.y, data.currency)}/t`
                : `${cx.dataset.label}: ${money(cx.parsed.y, data.currency)}`
            }
          }
        },
        scales:{
          yL:{
            position:'left',
            min: initMinL, max: initMaxL,
            grid:{ color:'#eef0f4' },
            ticks:{ maxTicksLimit:6, callback:(v)=>money(v, data.currency) }
          },
          yR:{
            position:'right',
            display: rightVals.length && rightVals.some(v=>v!==0),
            min: Math.max(0, initMinR), max: initMaxR,
            grid:{ drawOnChartArea:false },
            ticks:{ maxTicksLimit:6, callback:(v)=>`${money(v, data.currency)}/t` }
          },
          x:{ grid:{ color:'#f3f4f6' } }
        }
      }
    });

    // –ø–µ—Ä–µ—Å—á—ë—Ç –≥—Ä–∞–Ω–∏—Ü —Å —É—á—ë—Ç–æ–º —Å–∫—Ä—ã—Ç—ã—Ö/–ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π
    function recomputeBounds() {
      const visLeft = [];
      if (chart.isDatasetVisible(0)) visLeft.push(...finiteArr(chart.data.datasets[0].data));
      if (chart.isDatasetVisible(1)) visLeft.push(...finiteArr(chart.data.datasets[1].data));
      const visRight = chart.isDatasetVisible(2) ? finiteArr(chart.data.datasets[2].data) : [];

      const bL = bounds(visLeft);
      const bR = bounds(visRight);

      chart.options.scales.yL.min = bL.min;
      chart.options.scales.yL.max = bL.max;

      chart.options.scales.yR.display = visRight.length && visRight.some(v=>v!==0);
      if (chart.options.scales.yR.display) {
        chart.options.scales.yR.min = Math.max(0, bR.min);
        chart.options.scales.yR.max = bR.max;
      }
      chart.update();
    }

    // –∫–Ω–æ–ø–∫–∏-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
    const setBtn = (btn, on) => { btn.style.background = on ? '#08666e' : '#e5e7eb'; btn.style.color = on ? '#fff' : '#111'; };
    const btnNet = document.getElementById('tog-net');
    const btnSup = document.getElementById('tog-sup');
    const btnTpt = document.getElementById('tog-tpt');

    setBtn(btnNet, true); setBtn(btnSup, false); setBtn(btnTpt, false);

    btnNet.onclick = () => {
      chart.setDatasetVisibility(0, !chart.isDatasetVisible(0));
      setBtn(btnNet, chart.isDatasetVisible(0));
      recomputeBounds();
    };
    btnSup.onclick = () => {
      chart.setDatasetVisibility(1, !chart.isDatasetVisible(1));
      setBtn(btnSup, chart.isDatasetVisible(1));
      recomputeBounds();
    };
    btnTpt.onclick = () => {
      chart.setDatasetVisibility(2, !chart.isDatasetVisible(2));
      setBtn(btnTpt, chart.isDatasetVisible(2));
      recomputeBounds();
    };
  });
</script>

{% endblock %}
