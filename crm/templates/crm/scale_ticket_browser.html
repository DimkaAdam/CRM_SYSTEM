{% extends 'crm/index.html' %}
{% load static %}
{% load custom_tags %}
{% block title %}üìä Scale Tickets Archive{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
  .browser-container {
    background: #f5f5f5;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: auto;
  }
  .browser-header {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #222;
  }
  .toolbar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 0.95rem;
    text-decoration: none;
  }
  .back-link:hover { text-decoration: underline; color: #444; }

  .file-list { list-style: none; padding-left: 0; }
  .file-list li {
    margin: 0.45rem 0;
    font-size: 1.05rem;
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  }
  .file-list a { color: #08666e; text-decoration: none; }
  .file-list a:hover { color: #044f54; text-decoration: underline; }
  .file-item code { font-size: 11px; color: gray; }
  .btn { border: 0; padding: 4px 8px; border-radius: 8px; cursor: pointer; }
</style>


<div class="browser-header"><i class="fas fa-folder-tree"></i> Scale Tickets Archive</div>

<div class="toolbar">
  <div>
    {% if back_path %}
      <a href="?path={{ back_path|urlencode }}" class="back-link">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    {% endif %}
  </div>
  <div>
    {% if relative_path %}
      <a href="{% url 'scale_ticket_browser' %}" class="back-link">
        <i class="fas fa-home"></i> Root
      </a>
    {% endif %}
  </div>
</div>

  <ul class="file-list">
    {# --- –ü–ê–ü–ö–ò --- #}
    {% for folder in folders %}
      <li>
        <i class="fas fa-folder"></i>
        {% if relative_path %}
          {% with next_path=relative_path|add:'/'|add:folder %}
            <a href="{% url 'scale_ticket_browser' %}?path={{ next_path|urlencode }}">{{ folder }}</a>
          {% endwith %}
        {% else %}
            <a href="{% url 'scale_ticket_browser' %}?path={{ folder|urlencode }}">{{ folder }}</a>
        {% endif %}
      </li>
    {% endfor %}

    {# --- –§–ê–ô–õ–´ (PDF) --- #}
    {% for file in files %}
      <li class="file-item">
        <i class="fas fa-file-pdf"></i>

        {# —Å—Å—ã–ª–∫–∞ –Ω–∞ PDF: –∫–æ–¥–∏—Ä—É–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã, –Ω–æ –Ω–µ '/' #}
        <a
          href="/media/reports/scale_tickets/{% if relative_path %}{{ relative_path|urlencode:'/' }}/{% endif %}{{ file|urlencode }}"
          target="_blank"
        >{{ file }}</a>

        {# full_path —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞–∑–¥–µ–ª—å–Ω–æ –≤ –∫–∞–∂–¥–æ–π –≤–µ—Ç–∫–µ if #}
        {% if relative_path %}
          {% with full_path=relative_path|add:'/'|add:file %}
            {% if file_statuses|dictkey:full_path %}
              <button class="btn" style="color: green;" disabled>‚úÖ Sent</button>
            {% else %}
              <button
                class="btn send-email-btn"
                style="background-color: #d7263d; color: white;"
                data-path="{{ full_path }}"
              >
                <i class="fas fa-envelope"></i> Send
              </button>
              <code>{{ full_path }}</code>
            {% endif %}
          {% endwith %}
        {% else %}
          {% with full_path=file %}
            {% if file_statuses|dictkey:full_path %}
              <button class="btn" style="color: green;" disabled>‚úÖ Sent</button>
            {% else %}
              <button
                class="btn send-email-btn"
                style="background-color: #d7263d; color: white;"
                data-path="{{ full_path }}"
              >
                <i class="fas fa-envelope"></i> Send
              </button>
              <code>{{ full_path }}</code>
            {% endif %}
          {% endwith %}
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

<script>
  // –ö–Ω–æ–ø–∫–∞ "Send" ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ scale ticket –ø–æ email
  document.querySelectorAll('.send-email-btn').forEach((button) => {
    button.addEventListener('click', () => {
      const filePath = button.dataset.path;  // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤–Ω—É—Ç—Ä–∏ reports/scale_tickets
      const recipient = prompt("üìß Enter recipient email:");
      if (!recipient) return;

      fetch("{% url 'send_scale_ticket_email' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ path: filePath, email: recipient })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("‚úÖ Email sent!");
          location.reload();
        } else {
          alert("‚ùå Error: " + (data.error || "Unknown error"));
        }
      })
      .catch(err => alert("‚ùå Network error: " + err.message));
    });
  });
</script>
{% endblock %}
