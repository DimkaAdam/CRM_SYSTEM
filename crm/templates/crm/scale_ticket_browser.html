{% extends 'crm/index.html' %}
{% load static %}
{% load custom_tags %}
{% block title %}üìä Scale Tickets Archive{% endblock %}

{% block content %}
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
  body {
    color: #e5e7eb;
  }
  .browser-container {
    background: #111827;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 18px rgba(0,0,0,0.45);
    max-width: 960px;
    margin: 0 auto;
    color: #e5e7eb;
  }
  .browser-header {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #f9fafb;
  }
  .toolbar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #9ca3af;
    font-size: 0.95rem;
    text-decoration: none;
  }
  .back-link:hover {
    text-decoration: underline;
    color: #e5e7eb;
  }
  .file-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  .file-list li {
    margin: 0.45rem 0;
    font-size: 1.05rem;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    color: #e5e7eb;
  }
  .file-list a {
    color: #38bdf8;
    text-decoration: none;
  }
  .file-list a:hover {
    color: #7dd3fc;
    text-decoration: underline;
  }
  .file-item code {
    font-size: 11px;
    color: #6b7280;
  }
  .btn {
    border: 0;
    padding: 4px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
  }
</style>

<div class="browser-container"
     data-company-id="{{ company.id|default:'0' }}">

  <div class="browser-header">
    <i class="fas fa-folder-tree"></i> Scale Tickets Archive
  </div>

  {# ===== –ë–õ–û–ö –°–û –°–ü–ò–°–ö–û–ú E-MAIL –î–õ–Ø –ö–û–ú–ü–ê–ù–ò–ò ===== #}
  {% if company %}
  <div class="email-box"
       style="background:#1f2937; padding:20px; border-radius:12px; margin-bottom:20px;">
    <h3 style="margin:0 0 10px; color:#f9fafb;">
      Email recipients for {{ company.name }}
    </h3>

    <form action="{% url 'api_company_emails_add' company.id %}"
          method="post"
          style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:8px;">
      {% csrf_token %}
      <input name="name"
             placeholder="Label (–Ω–∞–ø—Ä–∏–º–µ—Ä AP)"
             style="flex:0 0 140px; padding:6px; background:#111827; border:1px solid #374151; border-radius:8px; color:#e5e7eb;">
      <input name="email"
             placeholder="email@example.com"
             required
             style="flex:0 0 220px; padding:6px; background:#111827; border:1px solid #374151; border-radius:8px; color:#e5e7eb;">
      <label style="display:flex; align-items:center; gap:4px; color:#e5e7eb;">
        <input type="checkbox" name="is_default">
        Default
      </label>
      <button type="submit"
              style="background:#08666e; color:white; border:0; padding:6px 14px; border-radius:8px;">
        Add
      </button>
    </form>

    <ul style="list-style:none; padding-left:0; margin:0;">
      {% for e in company.emails.all %}
        {% if e.active %}
        <li style="margin-bottom:6px; color:#e5e7eb;">
          {{ e.name }} &lt;{{ e.email }}&gt;
          {% if e.is_default %} <span style="color:#facc15;">‚òÖ</span>{% endif %}

          <form action="{% url 'api_company_emails_delete' company.id e.id %}"
                method="post"
                style="display:inline;">
            {% csrf_token %}
            <button style="background:#b91c1c; color:white; border:0; padding:4px 8px; border-radius:6px; margin-left:8px;">
              Delete
            </button>
          </form>
        </li>
        {% endif %}
      {% empty %}
        <li style="color:#9ca3af;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ ‚Äî –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω.</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="toolbar">
    <div>
      {% if back_path %}
        <a href="?path={{ back_path|urlencode }}" class="back-link">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      {% endif %}
    </div>
    <div>
      {% if relative_path %}
        <a href="{% url 'scale_ticket_browser' %}" class="back-link">
          <i class="fas fa-home"></i> Root
        </a>
      {% endif %}
    </div>
  </div>

  <ul class="file-list">
    {# --- –ü–ê–ü–ö–ò --- #}
    {% for folder in folders %}
      <li>
        <i class="fas fa-folder"></i>

        {% if relative_path %}
          {% with next_path=relative_path|add:'/'|add:folder %}
            <a href="{% url 'scale_ticket_browser' %}?path={{ next_path|urlencode }}&company={{ company.id }}">
              {{ folder }}
            </a>
          {% endwith %}
        {% else %}
          <a href="{% url 'scale_ticket_browser' %}?path={{ folder|urlencode }}&company={{ company.id }}">
            {{ folder }}
          </a>
        {% endif %}
      </li>
    {% endfor %}

    {# --- –§–ê–ô–õ–´ (PDF) --- #}
    {% for file in files %}
      <li class="file-item">
        <i class="fas fa-file-pdf"></i>

        <a href="/media/reports/scale_tickets/{% if relative_path %}{{ relative_path|urlencode:'/' }}/{% endif %}{{ file|urlencode }}"
           target="_blank">
          {{ file }}
        </a>

        {% if company %}
          {% if relative_path %}
            {% with full_path=relative_path|add:'/'|add:file %}
              {% if file_statuses|dictkey:full_path %}
                <button class="btn" style="color: #22c55e;" disabled>‚úÖ Sent</button>
              {% else %}
                <button class="btn send-email-btn"
                        style="background-color:#d7263d;color:#fff;"
                        data-path="{{ full_path }}">
                  <i class="fas fa-envelope"></i> Send
                </button>
                <code>{{ full_path }}</code>
              {% endif %}
            {% endwith %}
          {% else %}
            {% with full_path=file %}
              {% if file_statuses|dictkey:full_path %}
                <button class="btn" style="color: #22c55e;" disabled>‚úÖ Sent</button>
              {% else %}
                <button class="btn send-email-btn"
                        style="background-color:#d7263d;color:#fff;"
                        data-path="{{ full_path }}">
                  <i class="fas fa-envelope"></i> Send
                </button>
                <code>{{ full_path }}</code>
              {% endif %}
            {% endwith %}
          {% endif %}
        {% endif %}
      </li>
    {% endfor %}
  </ul>

</div> <!-- /browser-container -->

{# ===== –ú–û–î–ê–õ–ö–ê –û–¢–ü–†–ê–í–ö–ò –ü–ò–°–¨–ú–ê ===== #}
<div id="emailModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999;">
  <div style="max-width:560px; margin:6vh auto; background:#1f2937; color:#e5e7eb;
              border-radius:16px; padding:20px; box-shadow:0 10px 40px rgba(0,0,0,.35);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h3 style="margin:0; font-size:18px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å Scale Ticket</h3>
      <button id="closeEmailModalBtn" class="btn"
              style="background:#374151; color:#fff;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <input type="hidden" id="attachmentRelPath" value="">

    <div style="margin-top:14px;">
      <label style="font-size:13px; color:#cbd5e1;">–ö–æ–º—É</label>
      <input id="contactSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/email"
             style="width:100%; margin:6px 0 8px; padding:8px;
                    background:#111827; border:1px solid #374151; border-radius:10px;">
      <div id="contactList"
           style="max-height:240px; overflow:auto;
                  border:1px solid #374151; border-radius:10px; padding:8px;"></div>
    </div>

    <div style="margin-top:12px;">
      <label style="font-size:13px; color:#cbd5e1;">–¢–µ–º–∞</label>
      <input id="emailSubject"
             style="width:100%; padding:8px; background:#111827;
                    border:1px solid #374151; border-radius:10px;"
             value="Scale Ticket">
    </div>

    <div style="margin-top:12px;">
      <label style="font-size:13px; color:#cbd5e1;">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
      <textarea id="emailBody"
                style="width:100%; height:120px; padding:8px; background:#111827;
                       border:1px solid #374151; border-radius:10px;">
–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –û—Ç–ø—Ä–∞–≤–ª—è—é Scale Ticket –≤–æ –≤–ª–æ–∂–µ–Ω–∏–∏.
      </textarea>
    </div>

    <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="sendEmailBtn" class="btn"
              style="background:#d7263d; color:#fff;">
        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
      </button>
    </div>
  </div>
</div>

<script>
  const CONTEXT = "scale_ticket";

  const rootEl       = document.querySelector(".browser-container");
  const COMPANY_ID   = parseInt(rootEl?.dataset?.companyId || "0", 10);

  const emailModal      = document.getElementById("emailModal");
  const closeEmailModal = document.getElementById("closeEmailModalBtn");
  const contactListEl   = document.getElementById("contactList");
  const toInput         = document.getElementById("contactSearch");   // –≤–µ—Ä—Ö–Ω–µ–µ –ø–æ–ª–µ ¬´–ö–æ–º—É¬ª
  const subjectEl       = document.getElementById("emailSubject");
  const bodyEl          = document.getElementById("emailBody");
  const sendBtn         = document.getElementById("sendEmailBtn");
  const attachRelInput  = document.getElementById("attachmentRelPath");

  let allContacts = [];        // —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ email'—ã –∫–æ–º–ø–∞–Ω–∏–∏
  let selectedIds = new Set(); // id —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö email'–æ–≤, –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–∞–º–∏

  // ===== –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ Send –≤–æ–∑–ª–µ —Ñ–∞–π–ª–∞ =====
  document.querySelectorAll(".send-email-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!COMPANY_ID) {
        alert("–ß—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–∏–∫–µ—Ç—ã –ø–æ email, –∑–∞–π–¥–∏ –≤ –∞—Ä—Ö–∏–≤ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.");
        return;
      }
      const relPath = btn.dataset.path;
      attachRelInput.value = relPath;   // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ PDF
      openEmailModal();
    });
  });

  // –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
  async function openEmailModal() {
    emailModal.style.display = "block";
    toInput.focus();
    await loadContacts();
    renderContactList(allContacts);
  }

  // –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
  closeEmailModal.addEventListener("click", () => {
    emailModal.style.display = "none";
  });

  // ===== –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–Å–ù–ù–´–• EMAIL =====
  async function loadContacts() {
    const resp = await fetch(`/crm/api/companies/${COMPANY_ID}/emails/`);
    if (!resp.ok) {
      contactListEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞.";
      return;
    }

    const data = await resp.json();
    const emails = data.emails || [];

    // –ü—É—Å—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (!emails.length) {
      contactListEl.textContent = "–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.";
      return;
    }

    // –†–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö e-mail –Ω–∏–∂–µ –ø–æ–ª—è "–ö–æ–º—É"
    contactListEl.innerHTML = "";
    const ul = document.createElement("ul");
    ul.style.listStyle = "none";
    ul.style.paddingLeft = "0";

    emails.forEach(e => {
      const li = document.createElement("li");
      li.textContent = `${e.name || ""} ${e.email}`.trim();
      li.style.cursor = "pointer";
      li.style.padding = "2px 0";

      // –ø–æ –∫–ª–∏–∫—É –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–æ–ª–µ "–ö–æ–º—É"
      li.addEventListener("click", () => {
        toInput.value = e.email;
      });

      ul.appendChild(li);
    });

    contactListEl.appendChild(ul);

    // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ "–ö–æ–º—É" –ø—É—Å—Ç–æ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∏–ª–∏ –ø–µ—Ä–≤—ã–π
    if (!toInput.value) {
      const def = emails.find(x => x.is_default) || emails[0];
      if (def) {
        toInput.value = def.email;
      }
    }
  }

  // ===== –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê EMAIL =====
  function renderContactList(list) {
    contactListEl.innerHTML = "";
    if (!list.length) {
      const empty = document.createElement("div");
      empty.style.cssText = "padding:10px; color:#9ca3af; font-size:13px;";
      empty.textContent = "–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.";
      contactListEl.appendChild(empty);
      return;
    }
    list.forEach(c => {
      const row = document.createElement("label");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.gap = "8px";
      row.style.padding = "6px 4px";
      row.style.borderBottom = "1px solid rgba(255,255,255,0.06)";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedIds.has(c.id);
      cb.addEventListener("change", () => {
        if (cb.checked) selectedIds.add(c.id); else selectedIds.delete(c.id);
      });

      const text = document.createElement("span");
      text.textContent = `${c.name} ‚Äî ${c.email}`;

      row.appendChild(cb);
      row.appendChild(text);
      contactListEl.appendChild(row);
    });
  }

  // ===== –û–¢–ü–†–ê–í–ö–ê –ü–ò–°–¨–ú–ê =====
  sendBtn.addEventListener("click", async () => {
    const raw = (toInput.value || "").trim();
    if (!raw) {
      alert("–£–∫–∞–∂–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω email –ø–æ–ª—É—á–∞—Ç–µ–ª—è.");
      return;
    }

    // –†–∞–∑—Ä–µ—à–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é/—Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π/–ø—Ä–æ–±–µ–ª—ã
    const emails = raw
      .split(/[,; ]+/)
      .map(e => e.trim())
      .filter(Boolean);

    if (!emails.length) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å email.");
      return;
    }

    const form = new FormData();
    form.append("company_id", COMPANY_ID.toString());
    form.append("context", CONTEXT);
    form.append("subject", subjectEl.value || "(no subject)");
    form.append("body", bodyEl.value || "");
    form.append("attachment_relative", attachRelInput.value);
    form.append("emails_raw", JSON.stringify(emails));  // <<< –í–ê–ñ–ù–û

    const resp = await fetch("{% url 'api_send_report_email' %}", {
      method: "POST",
      headers: { "X-CSRFToken": getCsrfToken() },
      body: form,
    });

    if (!resp.ok) {
      const txt = await resp.text();
      alert("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + txt);
      return;
    }

    const data = await resp.json();
    alert("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + (data.sent_to || []).join(", "));
    emailModal.style.display = "none";
    location.reload();
  });

  // ===== CSRF =====
  function getCsrfToken() {
    const m = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }
</script>
{% endblock %}